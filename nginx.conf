server {
    listen 80;
    server_name localhost;
    resolver 127.0.0.11 valid=30s;

    set $auth_url http://auth-service:8080;
    set $classrooms_url http://classrooms-service:8080;
    # Исправлено: было 'ser', должно быть 'set'
    set $task_url http://task-service:8080;

    # --- Секции авторизации ---
    location = /auth {
        internal;
        proxy_pass $auth_url/api/Auth/validate;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header Authorization $http_authorization;
    }

    location = /auth_admin_only {
        internal;
        proxy_pass $auth_url/api/Auth/validate_admin; 
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header Authorization $http_authorization;
    }

    # --- Auth Service (Login/Register) ---
    location ~* ^/api/auth/(login|register) {
        rewrite ^/api/[Aa]uth/(.*) /api/Auth/$1 break;
        proxy_pass $auth_url;
        proxy_set_header Host $host;
    }

    # --- Classrooms Service ---
    location ~* ^/api/classrooms {
        error_page 418 = @classrooms_admin;
        error_page 419 = @classrooms_user;

        if ($request_method = POST) { return 418; }
        return 419;
    }

    # --- Task Manager Service (Новая секция) ---
    location ~* ^/api/tasks {
        error_page 418 = @tasks_admin;
        error_page 419 = @tasks_user;

        # Например: POST, PUT, DELETE требуют админа
        if ($request_method ~* ^(POST|PUT|DELETE)$ ) {
            return 418;
        }
        # Остальное (GET) доступно обычному пользователю
        return 419;
    }

    # --- Именованные локации для Classrooms ---
    location @classrooms_admin {
        auth_request /auth_admin_only;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header X-User-Id $user_id;
        proxy_pass $classrooms_url;
        proxy_set_header Host $host;
    }

    location @classrooms_user {
        auth_request /auth;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header X-User-Id $user_id;
        proxy_pass $classrooms_url;
        proxy_set_header Host $host;
    }

    # --- Именованные локации для Task Manager ---
    location @tasks_admin {
        auth_request /auth_admin_only;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header X-User-Id $user_id;
        proxy_pass $task_url;
        proxy_set_header Host $host;
    }

    location @tasks_user {
        auth_request /auth;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header X-User-Id $user_id;
        proxy_pass $task_url;
        proxy_set_header Host $host;
    }
}